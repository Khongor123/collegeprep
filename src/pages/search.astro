---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import PostPreview from '../components/PostPreview.astro';
import Search from '../icons/Search.astro';
import { sortItemsByDateDesc } from '../utils/data-utils';

const posts = (await getCollection('guide')).sort(sortItemsByDateDesc);
---

<BaseLayout
    title="Search"
    description="Search through our collection of college preparation guides and resources"
    showHeader={false}
>
    <div class="mb-12 sm:mb-16">
        <h1 class="text-2xl leading-tight font-serif italic sm:text-4xl mb-8">Search Guides</h1>

        <div class="relative max-w-md">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <Search />
            </div>
            <input
                type="text"
                id="search-input"
                class="block w-full pl-10 pr-3 py-2 border border-main rounded-md leading-5 bg-transparent placeholder-main/60 focus:outline-none focus:ring-2 focus:ring-main focus:border-transparent"
                placeholder="Search guides..."
                autocomplete="off"
                autocorrect="off"
                autocapitalize="off"
                spellcheck="false"
            />
        </div>
    </div>

    <div id="search-results" class="space-y-10 sm:space-y-12">
        {posts.map((post) => (
            <PostPreview post={post} class="search-result" data-title={post.data.title.toLowerCase()} />
        ))}
    </div>

    <div id="no-results" class="hidden text-center py-12">
        <p class="text-lg text-main/60">No guides found matching your search.</p>
    </div>
</BaseLayout>

<script is:inline>
    (function() {
        function initSearch() {
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results');
            const noResults = document.getElementById('no-results');
            const resultItems = document.querySelectorAll('.search-result');

            if (!searchInput || !searchResults || !noResults) {
                console.log('Search elements not found');
                return;
            }

            function performSearch(query) {
                const searchTerm = query.toLowerCase().trim();
                let hasResults = false;

                resultItems.forEach(function(item) {
                    const title = item.getAttribute('data-title') || '';
                    if (searchTerm === '' || title.includes(searchTerm)) {
                        item.style.display = 'block';
                        hasResults = true;
                    } else {
                        item.style.display = 'none';
                    }
                });

                if (searchTerm === '') {
                    searchResults.style.display = 'block';
                    noResults.style.display = 'none';
                } else if (hasResults) {
                    searchResults.style.display = 'block';
                    noResults.style.display = 'none';
                } else {
                    searchResults.style.display = 'none';
                    noResults.style.display = 'block';
                }
            }

            // Multiple event listeners for better mobile support
            searchInput.addEventListener('input', function(e) {
                performSearch(e.target.value);
            });

            searchInput.addEventListener('keyup', function(e) {
                performSearch(e.target.value);
            });

            searchInput.addEventListener('change', function(e) {
                performSearch(e.target.value);
            });

            // Touch events for mobile
            searchInput.addEventListener('touchend', function(e) {
                // Prevent zoom on iOS
                e.preventDefault();
                searchInput.focus();
            });

            // Handle paste events
            searchInput.addEventListener('paste', function(e) {
                setTimeout(function() {
                    performSearch(searchInput.value);
                }, 10);
            });

            // Initial search to show all results
            performSearch('');

            // Focus search input on page load (with delay for mobile)
            setTimeout(function() {
                searchInput.focus();
            }, 100);
        }

        // Multiple initialization methods for better mobile support
        function startSearch() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initSearch);
            } else {
                initSearch();
            }
        }

        // Start immediately
        startSearch();

        // Also try again after a short delay for mobile
        setTimeout(startSearch, 500);

        // Handle page visibility changes (mobile browser switching)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                setTimeout(startSearch, 100);
            }
        });
    })();
</script>